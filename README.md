# bedrock-deployer

[Deployer](https://deployer.org/) recipes for [Roots Bedrock](https://roots.io/bedrock/), also supports [Roots Sage](https://roots.io/sage/) and [Roots Trellis](https://roots.io/trellis/) setups.

Trellis provides a powerful deployment with Ansible. But if you would like to deploy Bedrock only while running a custom process, Deployer is a quick and simple alternative.

This recipes are based on excelent work from [Florian Moser](https://github.com/FlorianMoser/bedrock-deployer), with some spice ;)

**A word of caution:**

Make sure you have a backup of your local as well as your remote files, before experimenting with deployment recipes. Files might easily get overwritten when you provide wrong paths! You are solely responsible by using the recipes provided here.

## Installation

Use Composer:

```
$ composer require soumarco/bedrock-deployer
```

# Recipes

This package offers several recipes to help you with your Bedrock deployment. Require each package as needed.

Create a `deploy.php` file on Bedrock root folder.

## General configurations

Set a common folder to store all backups and database dumps generated by Deployer tasks.

Example:

`set('dump_folder', 'dump');`

> Deployer has a bug with 'test' and 'testLocally' functions, used to verify dump folder existence. Use `bedrock:prepare` task accordingly.

Deployer uses `rsync` to upload and download files from/to local/remote machines. If you are using Git on Windows on a local machine to run Deployer, `rsync` requires an absolute path to run. Set in `deploy.php`:

`set('is_windows_bash', true);`

This will parse all Windows-style paths to Linux-style paths when needed on `rsync`.

These are the available recipes:

## Bedrock DB

Provides tasks to export the database from the server and import it to your development machine and vice versa.

Requirements:

- Vagrant **running** on your local machine (or Trellis, of course)
- rsync running on local machine shell and remote machine
- WP CLI running on your Vagrant as well as on your remote machine

Load into your deploy.php file with:

```php
require 'vendor/soumarco/bedrock-deployer/recipe/bedrock_db.php';
```

Requires these Deployer environment variables to be set:

- local_bedrock_root: Absolute path to Bedrock root folder on local host machine
- vagrant_dir: Absolute path to directory that contains .vagrantfile
- vagrant_root: Absolute path to website inside Vagrant machine (should mirror local_root)

Example:

```php
set( 'local_bedrock_root', dirname( __FILE__ ) );
set( 'vagrant_dir', dirname( __FILE__ ) . '/../trellis' );
set( 'vagrant_root', '/srv/www/domain.com/current' );
```

### Task pull:db

Exports database on server and imports it into your local Vagrant database, while removing previous data. Creates a backup of the local database in the local_root directory, before importing the new data.

After the import, the WordPress URLs are converted from server URL to local URL, so your WordPress installation will continue to work right after the import.

Database credentials and URLs are read from remote and local .env file. So make sure, those files are up to date.

### Task push:db

Exports database from local Vagrant database and imports it into your remote server, while removing previous data. Creates a backup of the remote database on the server in the current release directory, before importing the new data.

After the import, the WordPress URLs are converted from local URL to remote URL, so your WordPress installation will continue to work right after the import.

Database credentials and URLs are read from remote and local .env file. So make sure, those files are up to date.

## Bedrock .env

Provides tasks to manage the .env file on the server.

Load into your deploy.php file with:

```php
require 'vendor/soumarco/bedrock-deployer/recipe/bedrock_env.php';
```

Requires no special Deployer environment variables to be set.

### Task bedrock:env

Tries to copy the .env file from a previous release to current release. If there is no previous release or if no .env file is available, the .env file is created while prompting the user for credentials.

When creating a new .env file, this task also generates the WordPress salts.

## Bedrock Miscellaneous

Provides miscellaneous Bedrock tasks.

Load into your deploy.php file with:

```php
require 'vendor/soumarco/bedrock-deployer/recipe/bedrock_misc.php';
```

Requires no special Deployer environment variables to be set.

### Task bedrock:vendors

Runs `composer install` for Bedrock on your server.

## Common

Provides common deployment tasks and functions.

Requirements:

- WP CLI running on your Vagrant as well as on your remote machine

Load into your deploy.php file with:

```php
require 'vendor/soumarco/bedrock-deployer/recipe/common.php';
```

Requires no special Deployer environment variables to be set.

### Task activate:plugins

Activates all plugins on remote server.

## Task bedrock:prepare

Check existence and creates `dump_folder` on local and remote machines.

## Filetransfer

Provides tasks to upload/download files from/to synced directories.

Requirements:

- A Zip library installed on local and remote machine.
- rsync running on local machine shell and remote machine

Load into your deploy.php file with:

```php
require 'vendor/soumarco/bedrock-deployer/recipe/filetransfer.php';
```

Requires these Deployer environment variables to be set:

- sync_dirs: Array of paths, that will be simultaneously updated with $absoluteLocalPath => $absoluteRemotePath.

Example:

```php
set( 'sync_dirs', [
    dirname( __FILE__ ) . '/web/app/uploads/' => '{{deploy_path}}/shared/web/app/uploads/',
] );
```

### Task pull:files

Will pull all files from each `$absoluteRemotePath` to each `$absoluteLocalPath`. New files will be added, existing files will be updated, but files existing locally only will not be deleted.

If you prefer to pull the files without making a backup, consider using the task `pull:files-no-bak`.

### Task push:files

Will push all files from each `$absoluteLocalPath` to each `$absoluteRemotePath`. New files will be added, existing files will be updated, but files existing on remote server only will not be deleted.

If you prefer to push the files without making a backup, consider using the task `push:files-no-bak`.

`pull:files` and `push:files` will ensure no files are lost. They are backed up in a zip file that will be stored in `dump_folder`. Existing backups from previous pulls are not included in a new backup.

If you push/pull files without database backup/restore, files will not show in Wordpress Media Library!

TODO:

- add a task to import media from files to Wordpress Media Library.

## Sage

Provides tasks to deploy Roots Sage theme.

Requirements:

- Roots Sage 9.0.\*

Load into your deploy.php file with:

```php
require 'vendor/soumarco/bedrock-deployer/recipe/sage.php';
```

Requires these Deployer environment variables to be set:

- theme_path: Path to theme, relative to release_path
- local_root: Absolute path to website root directory on local host machine

Example:

```php
set( 'local_root', dirname( __FILE__ ) );
set( 'theme_path', 'web/app/themes/theme-name' );
```

### Task sage:vendors

Runs `composer install` inside Sage theme directory.

### Task sage:assets

Compiles the Sage assets on the local machine and then uploads them to remote server in theme directory (overwriting previous assets!).

## Trellis

You will not want to use these recipes to deploy Trellis. Trellis has its own and powerful deployment process. However you might use Trellis for developing and only use these recipes to deploy Bedrock.

The downside with this method is that you will have a /site as well as a /trellis directory in your repository. So both directories will be cloned to the server.

This task deals with this situation:

### Task trellis:remove

Will delete the remote /trellis directory and move the content of /site to /. Use this task after deployment but before symlink changes.
